in_toks = [[7, 663, 481, 6174, 665, 665, 665, 665, 1081, 755, 1278, 763, 1039, 710, 1596, 781, 1094, 772, 1308, 755, 1056, 763, 869, 680, 1342, 892, 1056, 702, 1081, 755, 1278, 763, 1039, 680, 1596, 755, 1094, 755, 1308, 763, 1056, 763, 1081, 755, 1401, 1147, 1105, 702, 1358, 710, 1444, 681, 1039, 702, 1385, 880, 1501, 718, 1656, 781, 1201, 909, 3909, 755, 1864, 756, 1224, 702, 1057, 1006, 847, 3993, 1342, 892, 8194, 702, 1213, 702, 8, 7, 663, 447, 6174, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 3, 3, 3, 665, 549, 555, 562, 564, 569, 146, 4884, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 8, 7, 663, 438, 6174, 665, 665, 665, 665, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 1265, 1380, 8199, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 936, 8, 7, 663, 526, 6174, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 186, 1123, 188, 1502, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 2146, 8150, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 188, 1502, 1123, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 8, 5]]

[7, 663, 481, 6174, 665, 665, 665, 665, 1081, 755, 1278, 763, 1039, 710, 1596, 781, 1094, 772, 1308, 755, 1056, 763, 869, 680, 1342, 892, 1056, 702, 1081, 755, 1278, 763, 1039, 680, 1596, 755, 1094, 755, 1308, 763, 1056, 763, 1081, 755, 1401, 1147, 1105, 702, 1358, 710, 1444, 681, 1039, 702, 1385, 880, 1501, 718, 1656, 781, 1201, 909, 3909, 755, 1864, 756, 1224, 702, 1057, 1006, 847, 3993, 1342, 892, 8194, 702, 1213, 702, 8, 7, 663, 447, 6174, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, -100, -100, -100, 665, -100, -100, -100, -100, -100, 146, 4884, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 8, 7, 663, 438, 6174, 665, 665, 665, 665, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 1265, 1380, 8199, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 936, 8, 7, 663, 526, 6174, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713,
 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 186, 1123, 188, 1502, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 2146, 8150, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 188, 1502, 1123, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 8, -100, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 665, -100, -100, -100, -100, -100, 146, 4884, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 6,]

desired = [[7, 663, 481, 6174, 665, 665, 665, 665, 1081, 755, 1278, 763, 1039, 710, 1596, 781, 1094, 772, 1308, 755, 1056, 763, 869, 680, 1342, 892, 1056, 702, 1081, 755, 1278, 763, 1039, 680, 1596, 755, 1094, 755, 1308, 763, 1056, 763, 1081, 755, 1401, 1147, 1105, 702, 1358, 710, 1444, 681, 1039, 702, 1385, 880, 1501, 718, 1656, 781, 1201, 909, 3909, 755, 1864, 756, 1224, 702, 1057, 1006, 847, 3993, 1342, 892, 8194, 702, 1213, 702, 8, 7, 663, 447, 6174, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, -100, -100, -100, 665, -100, -100, -100, -100, -100, 146, 4884, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 869, 759, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 8, 7, 663, 438, 6174, 665, 665, 665, 665, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 1265, 1380, 8199, 875, 936, 1164, 672, 11811, 875, 936, 1164, 672, 842, 936, 8, 7, 663, 526, 6174, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 186, 1123, 188, 1502, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 2146, 8150, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 3119, 1502, 1123, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 188, 1502, 1123, 873, 2146, 977, 2544, 1123, 150, 1502, 1205, 2391, 1713, 1123, 6626, 1090, 2839, 1502, 1123, 2417, 977, 1502, 1123, 174, 2771, 1205, 2707, 1713, 1123, 180, 1502, 6520, 1090, 1713, 8, -100, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 665, -100, -100, -100, -100, -100, 146, 4884, 6487, 1063, 851, 41, 851, 997, 1283, 41, 1283, 860, 759, 12771, 1008, 851, 39, 851, 937, 1283, 39, 1283, 6]]


if __name__ == "__main__":
    import fla
    from transformers import GenerationConfig, AutoModelForCausalLM
    from symusic import Synthesizer, dump_wav, Score
    from miditok import MMM, TokSequence
    from pathlib import Path
    from torch import LongTensor
    
    current_dir = Path(__file__).absolute().parent
    TOK_PATH = current_dir.parent / "tokenizer/tokenizer_with_acs.json"
    MODEL_PATH = "../outputs/m2fla"
    INPUT_PATH = str(current_dir / "mat/rollinggirlEDIT.mid")
    OUTPUT_PATH = str(current_dir / "mat/output.mid")
    OUTWAV_PATH = str(current_dir / "mat/output.wav")
    INWAV_PATH = str(current_dir / "mat/input.wav")
    OUTPR_PATH = str(current_dir / "mat/output.png")
    INPR_PATH = str(current_dir / "mat/input.png")
    
    tokenizer = MMM(params=TOK_PATH)
    model = AutoModelForCausalLM.from_pretrained(MODEL_PATH).to("cuda")

    print("Generating...")

    output_ids = model.generate(LongTensor(in_toks).to("cuda"))
    output_seq = TokSequence(ids=output_ids[0].tolist(), are_ids_encoded=True)
    tokenizer.decode_token_ids(output_seq)
    output_seq.tokens = tokenizer._ids_to_tokens(output_seq.ids)

    print(output_seq)
    print(output_seq.ids)
    print(output_seq.tokens)
    
    # print("Done generating. Dumping MIDI...")

    # Create MIDI output
    # output_seq.dump_midi(OUTPUT_PATH)
    # print("Dumped MIDI, synthesizing...")

    # synth
    # synth = Synthesizer()
    # outscore = Score(OUTPUT_PATH)
    # inscore = Score(INPUT_PATH)
    # outwav = synth.render(outscore, stereo=True)
    # inwav = synth.render(inscore, stereo=True)
    # dump_wav(OUTWAV_PATH, outwav, sample_rate=44100, use_int16=True)
    # dump_wav(INWAV_PATH, inwav, sample_rate=44100, use_int16=True)

    # print("Synthesized, plotting piano rolls...")

    # # matplotlib
    # from matplotlib import pyplot as plt
    # intrack = inscore.resample(tpq=6, min_dur=1).tracks[2].pianoroll(modes=["onset", "frame"], pitch_range=[0, 128], encode_velocity=False)
    # outtrack = outscore.resample(tpq=6, min_dur=1).tracks[2].pianoroll(modes=["onset", "frame"], pitch_range=[0, 128], encode_velocity=False)

    # intrack_truncated = [intrack[0][:, :500], intrack[1][:, :500]]
    # outtrack_truncated = [outtrack[0][:, :500], outtrack[1][:, :500]]
    # plt.imshow(intrack_truncated[0] + intrack_truncated[1], aspect="auto", origin="lower")
    # plt.savefig(INPR_PATH, dpi=300, bbox_inches="tight")
    # plt.close()
    # plt.imshow(outtrack_truncated[0] + outtrack_truncated[1], aspect="auto", origin="lower")
    # plt.savefig(OUTPR_PATH, dpi=300, bbox_inches="tight")
    

